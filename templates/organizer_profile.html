<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Профиль организатора - {{ organizer.username }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* Стили для секции мероприятий на странице организатора */
        .organizer-posts-container {
            width: calc(100% - 40px);
            gap: 20px;
            display: grid;
            padding: 20px;
            min-height: 700px;
        }
        
        .organizer-post {
            display: flex;
            flex-direction: row;
            background: rgba(0, 0, 0, 0.49);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 20px;
            align-items: flex-start;
            height: 500px;
            box-sizing: border-box;
        }
        
        .organizer-post:hover {
            background: rgba(0, 0, 0, 0.6);
            transform: scale(1.02);
        }
    </style>
</head>
<body>

<div class="header">
    <div class="user-container" id="userContainer">
        <div class="user-circle"></div>
        {% if session.username %}
            <div class="user-menu" id="userMenu">
                <a href="{{ url_for('logout') }}">Выйти</a>
                <a href="{{ url_for('register') }}">Сменить аккаунт</a>
                <a href="{{ url_for('user_preferences') }}">Мои интересы</a>
                {% if session.role == 'organizer' %}
                    <a href="{{ url_for('add_event') }}">Добавить мероприятие</a>
                    <a href="{{ url_for('add_tag') }}">Добавить тег</a>
                {% endif %}
            </div>
        {% else %}
            <div class="user-menu" id="userMenu">
                <a href="{{ url_for('login') }}">Войти</a>
                <a href="{{ url_for('register') }}">Регистрация</a>
            </div>
        {% endif %}
    </div>

    <div class="org-menu-buttons">
        <a href="{{ url_for('home') }}" class="menu-btn map-btn">
            <img src="{{ url_for('static', filename='images/home.png') }}" alt="Главная" class="icon home-icon">
            Главная
        </a>
        
        <a href="{{ url_for('show_map') }}" class="menu-btn map-btn">
            <img src="{{ url_for('static', filename='images/map.png') }}" alt="Карта" class="icon">
            Карта
        </a>

        <div class="search-container">
            <form method="GET" action="{{ url_for('home') }}" class="search-form">
                <input class="search-input" type="text" name="search" placeholder="Поиск мероприятий..." 
                       value="{{ search_query|default('') }}">
                <button class="search-btn menu-btn" type="submit">
                    <img src="{{ url_for('static', filename='images/search.png') }}" alt="Поиск" class="icon">
                </button>
            </form>
        </div>
        
        <form method="GET" action="{{ url_for('organizer_profile', organizer_id=organizer.id) }}" style="display: inline;">
            <select class="menu-btn" onchange="filterPosts('tag', this.value)">
                <option value="">Все категории</option>
                {% for tag in tags %}
                    <option value="{{ tag.name }}" {% if tag.name == selected_tag %}selected{% endif %}>
                        {{ tag.name }}
                    </option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>

<div class="posts-wrapper">
    <div class="posts-header">
        <h2>Профиль организатора</h2>
    </div>
    {% if not organizer %}
        <div class="error-message">
            Организатор не найден
            <a href="{{ url_for('home') }}">Вернуться на главную</a>
        </div>
    {% else %}
        <div class="organizer-header" style="margin: 30px 55px;">
            <div class="organizer-avatar">
                {{ organizer.username[0]|upper }}
            </div>
            <div class="organizer-info">
                <h1>{{ organizer.username }}</h1>
                <p class="role-badge">Организатор</p>

                <div class="stats">
                    <div class="stat">
                        <span class="stat-number">{{ events|length }}</span>
                        <span class="stat-label">Мероприятий</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number">{{ subscribers_count }}</span>
                        <span class="stat-label">Подписчиков</span>
                    </div>
                </div>

                <div class="organizer-rating">
                    <span class="rating">
                        {% for i in range(5) %}
                            {% if i < organizer.avg_rating|int %}
                                <span class="star filled">★</span>
                            {% else %}
                                <span class="star">☆</span>
                            {% endif %}
                        {% endfor %}
                        ({{ "%.1f"|format(organizer.avg_rating) }})
                    </span>
                </div>

                {% if 'username' in session and session['username'] != organizer.username %}
                    <form action="{{ url_for('subscribe', organizer_id=organizer.id) }}" method="POST">
                        <button type="submit" class="{{ 'unsubscribe' if is_subscribed else 'subscribe' }}-btn">
                            {{ 'Отписаться' if is_subscribed else 'Подписаться' }}
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>

        <div class="organizer-reviews" style="margin: 30px 55px;">
            <h3>Отзывы об организаторе</h3>
            
            <div class="reviews-container">
                {% for review in organizer_reviews %}
                <div class="review-item">
                    <div class="review-header">
                        <span class="reviewer-name">{{ review.reviewer.username }}</span>
                        <div class="rating">
                            {% for i in range(5) %}
                                {% if i < review.rating %}
                                    <span class="star filled">★</span>
                                {% else %}
                                    <span class="star">☆</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="review-date">{{ review.created_at.strftime('%d.%m.%Y') }}</span>
                    </div>
                    <div class="review-content">
                        {{ review.comment }}
                    </div>
                </div>
                {% endfor %}
                
                {% if not organizer_reviews %}
                <p>Пока нет отзывов об этом организаторе</p>
                {% endif %}
            </div>
            
            {% if session.username and session.username != organizer.username %}
            <div class="review-form">
                <h4>Оставить отзыв</h4>
                <form action="{{ url_for('add_organizer_review', organizer_id=organizer.id) }}" method="POST">
                    <div class="rating-stars">
                        <input type="radio" id="orgstar5" name="rating" value="5">
                        <label for="orgstar5">&#9733;</label>
                        <input type="radio" id="orgstar4" name="rating" value="4">
                        <label for="orgstar4">&#9733;</label>
                        <input type="radio" id="orgstar3" name="rating" value="3">
                        <label for="orgstar3">&#9733;</label>
                        <input type="radio" id="orgstar2" name="rating" value="2">
                        <label for="orgstar2">&#9733;</label>
                        <input type="radio" id="orgstar1" name="rating" value="1">
                        <label for="orgstar1">&#9733;</label>
                    </div>
                    <textarea name="comment" placeholder="Ваш отзыв об организаторе..."></textarea>
                    <button type="submit" class="submit-review-btn">Отправить</button>
                </form>
            </div>
            {% endif %}
        </div>

        <div style="background: transparent; padding: 0;">
            <div class="posts-header" style="margin: 40px 0 20px 55px;">
                <h2>Мероприятия организатора:</h2>
            </div>
            {% if events %}
                <div class="organizer-posts-container">
                    {% for event in events %}
                        <div class="organizer-post" onclick="showModal(
                                '{{ event.title }}',
                                '{{ event.description }}',
                                '{{ event.location }}',
                                '{{ event.tags|map(attribute="name")|join(", ") }}',
                                '{{ event.event_type }}',
                                {{ event.lat|default(0) }},
                                {{ event.lng|default(0) }},
                                '{% if event.title == 'Концерт в Минске' %}{{ url_for("static", filename="images/event1.png") }}{% elif event.title == 'Выставка картин' %}{{ url_for("static", filename="images/event2.png") }}{% elif event.image_url %}{{ url_for("static", filename="uploads/" + event.image_url.split("/")[-1]) }}{% else %}{{ url_for("static", filename="images/default-event.jpg") }}{% endif %}',
                                '{{ organizer.username }}',
                                {{ organizer.id }},
                                '{{ event.date_time.strftime("%Y-%m-%d %H:%M") }}',
                                {{ event.id }}
                                )">
                            <img class="post-image"
                                 src="{% if event.title == 'Концерт в Минске' %}
                                     {{ url_for('static', filename='images/event1.png') }}
                                  {% elif event.title == 'Выставка картин' %}
                                     {{ url_for('static', filename='images/event2.png') }}
                                  {% elif event.image_url %}
                                     {{ url_for('static', filename='uploads/' + event.image_url.split('/')[-1]) }}
                                  {% else %}
                                     {{ url_for('static', filename='images/default-event.jpg') }}
                                  {% endif %}"
                                 alt="{{ event.title }}">
                
                            <div class="post-content">
                                <h3>{{ event.title }}</h3>
                                <p>{{ event.description|truncate(100) }}</p>
                                <p><strong>Рейтинг:</strong> 
                                    <span class="rating">
                                        {% for i in range(5) %}
                                            {% if i < event.avg_rating|int %}
                                                <span class="star filled">★</span>
                                            {% else %}
                                                <span class="star">☆</span>
                                            {% endif %}
                                        {% endfor %}
                                        ({{ "%.1f"|format(event.avg_rating) }})
                                    </span>
                                </p>
                                <p class="tags" style="color: #9BB8FF; font-weight: bold;">
                                    Теги: {{ event.tags|map(attribute='name')|join(', ') }}
                                </p>
                                <p>Тип мероприятия: {{ event.event_type }}</p>
                                <p>Адрес: {{ event.location }}</p>
                                <p>Дата: {{ event.date_time.strftime("%d.%m.%Y %H:%M") }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="no-events" style="text-align: center; font-size: 24px; margin: 50px 0;">Нет мероприятий</p>
            {% endif %}
        </div>
    {% endif %}

    <!-- Модальное окно для мероприятия -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="hideModal()">×</span>
            <img id="modal-image" class="modal-image"
                 src="{{ url_for('static', filename='images/default-event.jpg') }}"
                 alt="Изображение мероприятия">
            <div class="modal-details">
                <h2 id="modal-title"></h2>
                <p id="modal-description"></p>
                <p><strong>Место:</strong> <span id="modal-location"></span></p>
                <p><strong>Дата:</strong> <span id="modal-date"></span></p>
                <p><strong>Теги:</strong> <span id="modal-tags"></span></p>
                <p><strong>Тип:</strong> <span id="modal-event-type"></span></p>
                <p><strong>Организатор:</strong>
                    <a id="modal-organizer-link" href="#" class="organizer-link">
                        <span id="modal-organizer"></span>
                    </a>
                </p>
                <!-- В блок modal-details добавим форму для отзывов -->
                <div class="reviews-section">
                    <h3>Отзывы</h3>

                    <div id="event-reviews">
                        <!-- Здесь будут отзывы -->
                    </div>

                    {% if session.username %}
                    <div class="review-form">
                        <h4>Оставить отзыв</h4>
                        <form id="event-review-form" method="POST">
                            <div class="rating-stars">
                                <input type="radio" id="star5" name="rating" value="5">
                                <label for="star5">&#9733;</label>
                                <input type="radio" id="star4" name="rating" value="4">
                                <label for="star4">&#9733;</label>
                                <input type="radio" id="star3" name="rating" value="3">
                                <label for="star3">&#9733;</label>
                                <input type="radio" id="star2" name="rating" value="2">
                                <label for="star2">&#9733;</label>
                                <input type="radio" id="star1" name="rating" value="1">
                                <label for="star1">&#9733;</label>
                            </div>
                            <textarea name="comment" placeholder="Ваш отзыв..."></textarea>
                            <button type="submit" class="submit-review-btn">Отправить</button>
                        </form>
                    </div>
                    {% else %}
                    <p>Войдите, чтобы оставить отзыв</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>