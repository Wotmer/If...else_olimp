<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>BSU App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

<div class="header">
    <!-- Пользовательское меню -->
    <div class="user-container" id="userContainer">
        <div class="user-circle"></div>
        {% if session.username %}
            <div class="user-menu" id="userMenu">
                <a href="{{ url_for('logout') }}">Выйти</a>
                <a href="{{ url_for('register') }}">Сменить аккаунт</a>
                {% if session.role == 'organizer' %}
                    <a href="{{ url_for('add_event') }}">Добавить мероприятие</a>
                    <a href="{{ url_for('add_tag') }}">Добавить тег</a>
                {% endif %}
            </div>
        {% else %}
            <div class="user-menu" id="userMenu">
                <a href="{{ url_for('login') }}">Войти</a>
                <a href="{{ url_for('register') }}">Регистрация</a>
            </div>
        {% endif %}
    </div>

    <!-- Меню и поиск -->
    <div class="menu-buttons">
        <a href="{{ url_for('show_map') }}" class="menu-btn map-btn">
            <img src="{{ url_for('static', filename='images/map.png') }}" alt="Карта" class="icon">
            Карта
        </a>

        <div class="search-container">
            <form method="GET" action="/" class="search-form">
                <input class="search-input" type="text" name="search" placeholder="Поиск..."
                       value="{{ search_query|default('') }}">
                <button class="search-btn menu-btn" type="submit">
                    <img src="{{ url_for('static', filename='images/search.png') }}" alt="Поиск" class="icon">
                </button>
            </form>
        </div>

        <form method="GET" action="/" style="display: inline;">
            <select name="tag" class="menu-btn" onchange="this.form.submit()">
                <option value="">Все категории</option>
                {% for tag in tags %}
                    <option value="{{ tag.name }}" {% if tag.name == selected_tag %}selected{% endif %}>
                        {{ tag.name }}
                    </option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>

<!-- Список мероприятий -->
<div class="posts-wrapper">
    <div class="posts-header">
        <h2>Мероприятия:</h2>
    </div>
    <div class="posts-container">
        {% for post in posts %}
            <div class="post" onclick="showModal(
                    '{{ post.title }}',
                    '{{ post.description }}',
                    '{{ post.location }}',
                    '{{ post.tags|map(attribute="name")|join(", ") }}',
                    '{{ post.event_type }}',
                    {{ post.lat|default(0) }},
                    {{ post.lng|default(0) }},
                    {% if post.title == 'Концерт в Минске' %}
                        '{{ url_for("static", filename="images/event1.png") }}',
                    {% elif post.title == 'Выставка картин' %}
                        '{{ url_for("static", filename="images/event2.png") }}',
                    {% elif post.image_url %}
                        '{{ url_for("static", filename="uploads/" + post.image_url.split("/")[-1]) }}',
                    {% else %}
                        '{{ url_for("static", filename="images/default-event.jpg") }}',
                    {% endif %}
                    '{{ post.organizer.username }}',
                    {{ post.organizer.id }},
                    '{{ post.date_time.strftime("%Y-%m-%d %H:%M") }}'
                    )">
                <img class="post-image"
                     src="{% if post.title == 'Концерт в Минске' %}
                             {{ url_for('static', filename='images/event1.png') }}
                          {% elif post.title == 'Выставка картин' %}
                             {{ url_for('static', filename='images/event2.png') }}
                          {% elif post.image_url %}
                             {{ url_for('static', filename='uploads/' + post.image_url.split('/')[-1]) }}
                          {% else %}
                             {{ url_for('static', filename='images/default-event.jpg') }}
                          {% endif %}"
                     alt="{{ post.title }}">
                <div class="post-content">
                    <h3>{{ post.title }}</h3>
                    <p>{{ post.description|truncate(100) }}</p>
                    <p class="tags" style="color: #9BB8FF; font-weight: bold;">
                        Теги: {{ post.tags|map(attribute='name')|join(', ') }}
                    </p>
                    <p>Тип мероприятия: {{ post.event_type }}</p>
                    <p>Адрес: {{ post.location }}</p>
                    <p>
                        Организатор:
                        <a href="{{ url_for('organizer_profile', organizer_id=post.organizer.id) }}"
                           class="organizer-link"
                           onclick="event.stopPropagation()"
                           style="color: #9BB8FF; text-decoration: none;">
                            {{ post.organizer.username }}
                        </a>
                    </p>
                </div>
                {% if session.username and session.role == 'participant' and post.organizer.id != user.id %}
                    <div class="subscribe-btn-container">
                        {% if user.id in post.organizer.subscribers|map(attribute='user_id') %}
                            <form action="{{ url_for('subscribe', organizer_id=post.organizer.id) }}" method="POST">
                                <button type="submit" class="unsubscribe-btn">Отписаться</button>
                            </form>
                        {% else %}
                            <form action="{{ url_for('subscribe', organizer_id=post.organizer.id) }}" method="POST">
                                <button type="submit" class="subscribe-btn">Подписаться</button>
                            </form>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <!-- Модальное окно для мероприятия -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="hideModal()">×</span>
            <img id="modal-image" class="modal-image"
                 src="{{ url_for('static', filename='images/default-event.jpg') }}"
                 alt="Изображение мероприятия">
            <div class="modal-details">
                <h2 id="modal-title"></h2>
                <p id="modal-description"></p>
                <p><strong>Место:</strong> <span id="modal-location"></span></p>
                <p><strong>Дата:</strong> <span id="modal-date"></span></p>
                <p><strong>Теги:</strong> <span id="modal-tags"></span></p>
                <p><strong>Тип:</strong> <span id="modal-event-type"></span></p>
                <p><strong>Организатор:</strong>
                    <a id="modal-organizer-link" href="#" class="organizer-link">
                        <span id="modal-organizer"></span>
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>